
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Algorithm Development &#8212; QC Lab  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=744294ec" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/algorithm_dev';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Software Reference" href="../software_reference/index.html" />
    <link rel="prev" title="Default Behavior" href="defaults.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo-light.png" class="logo__image only-light" alt="QC Lab  documentation - Home"/>
    <img src="../_static/logo-dark.png" class="logo__image only-dark pst-js-only" alt="QC Lab  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../nested_docs/index.html">
    Interactive Documentation
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../software_reference/index.html">
    Software Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/tempelaar-team/qc_lab" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../nested_docs/index.html">
    Interactive Documentation
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../software_reference/index.html">
    Software Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/tempelaar-team/qc_lab" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="quickstart/quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="drivers/drivers.html">Dynamics Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/algorithms.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_object.html">Data Object</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_dev.html">Model Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="defaults.html">Default Behavior</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Algorithm Development</a></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Algorithm Development</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="algorithm-development">
<span id="algorithm-dev"></span><h1>Algorithm Development<a class="headerlink" href="#algorithm-development" title="Link to this heading">#</a></h1>
<p>In this guide, we will discuss how to make in-place modifications to Algorithms. Algorithm development is a
more advanced topic and requires a good understanding of the underlying steps of the algorithm so we will not
go into detail (in this guide) about how to develop a new algorithm from scratch. Instead, we will focus
on making changes to existing algorithms.</p>
<p>Before we proceed, let’s discuss the structure of an algorithm in QC Lab. An algorithm in QC Lab is a Python
class that inherits from the <cite>Algorithm</cite> class in the <cite>qc_lab.algorithm</cite> module. The built-in algorithms are
found in the <cite>qc_lab.algorithms</cite> module and presently contain <cite>qc_lab.algorithms.MeanField</cite> and
<cite>qc_lab.algorithms.FewestSwitchesSurfaceHopping</cite>.</p>
<p>We can start by importing the <cite>MeanField</cite> algorithm from the <cite>qc_lab.algorithms</cite> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qc_lab.algorithms</span> <span class="kn">import</span> <span class="n">MeanField</span>
</pre></div>
</div>
<p>Each algorithm consists of three lists of functions which are referred to as “recipes”, the functions themselves are
referred to as “tasks”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the initialization recipe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MeanField</span><span class="o">.</span><span class="n">initialization_recipe</span><span class="p">)</span>

<span class="c1"># the update recipe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MeanField</span><span class="o">.</span><span class="n">update_recipe</span><span class="p">)</span>

<span class="c1"># the output recipe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MeanField</span><span class="o">.</span><span class="n">output_recipe</span><span class="p">)</span>
</pre></div>
</div>
<p>As the name implies, the <cite>initialization_recipe</cite> initializes all the variables required for the algorithm. The <cite>update_recipe</cite>
updates the variables at each time step, and the <cite>output_recipe</cite> is used to output the results of the algorithm.</p>
<p>In addition to the recipes, a list of variable names is needed to specify which variables the algorithm will store in the Data object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the variables that the algorithm will store</span>
<span class="nb">print</span><span class="p">(</span><span class="n">MeanField</span><span class="o">.</span><span class="n">output_variables</span><span class="p">)</span>
</pre></div>
</div>
<section id="adding-output-obvservables">
<h2>Adding output obvservables<a class="headerlink" href="#adding-output-obvservables" title="Link to this heading">#</a></h2>
<p>To add an additional variable to the output of an algorithm we must define a task that calculates the variable and add it to the output recipe.</p>
<section id="linear-response-functions">
<h3>Linear response functions<a class="headerlink" href="#linear-response-functions" title="Link to this heading">#</a></h3>
<p>For example, let’s calculate a linear response function that can be used to calculate the absorption spectrum of a system. Mathematically we will calculate</p>
<div class="math notranslate nohighlight">
\[R(t) = \langle \psi(0) \vert \psi(t)\rangle\]</div>
<p>where <span class="math notranslate nohighlight">\(\vert \psi(t)\rangle\)</span> is the diabatic wavefunction at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_response_function</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># First get the diabatic wavefunction.</span>
    <span class="n">wf_db</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">wf_db</span>
    <span class="c1"># If we are at the first timestep we can store the diabatic wavefunction in the parameters object</span>
    <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">t_ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">wf_db_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wf_db</span><span class="p">)</span>
    <span class="c1"># Next calculate the response function and store it in the state object.</span>
    <span class="n">state</span><span class="o">.</span><span class="n">response_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">wf_db_0</span><span class="p">)</span> <span class="o">*</span> <span class="n">wf_db</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">state</span>
</pre></div>
</div>
<p>Next we can add this task to the output recipe.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MeanField</span><span class="o">.</span><span class="n">output_recipe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_response_function</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally we can add the relevant variable name to the output_variables list.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MeanField</span><span class="o">.</span><span class="n">output_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;response_function&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can then run a simulation and calculate the corresponding spectral function,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qc_lab</span> <span class="kn">import</span> <span class="n">Simulation</span>
<span class="kn">from</span> <span class="nn">qc_lab.dynamics</span> <span class="kn">import</span> <span class="n">parallel_driver_multiprocessing</span>
<span class="kn">from</span> <span class="nn">qc_lab.models</span> <span class="kn">import</span> <span class="n">SpinBoson</span>

<span class="c1"># instantiate a simulation</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default simulation settings: &#39;</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">default_settings</span><span class="p">)</span>

<span class="c1"># change settings to customize simulation</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">num_trajs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># instantiate a model</span>
<span class="n">sim</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SpinBoson</span><span class="p">({</span><span class="s1">&#39;l_reorg&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default model constants: &#39;</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">default_constants</span><span class="p">)</span> <span class="c1"># print out default constants</span>

<span class="c1"># instantiate an algorithm</span>
<span class="n">sim</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">MeanField</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default algorithm settings: &#39;</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">default_settings</span><span class="p">)</span> <span class="c1"># print out default settings</span>



<span class="c1"># define an initial diabatic wavefunction</span>
<span class="n">sim</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">wf_db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># run the simulation</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">parallel_driver_multiprocessing</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">num_tasks</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># plot the data.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calculated quantities:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">response_function</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;response_function&#39;</span><span class="p">]</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tdat_output</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">response_function</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;R(t)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;response function&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">response_function</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;freq&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;absorbance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="adiabatic-populations">
<h3>Adiabatic populations<a class="headerlink" href="#adiabatic-populations" title="Link to this heading">#</a></h3>
<p>Next, let’s calculate the adiabatic populations of the system as is sometimes done in scattering problems. Obviously these populations
will only have a well-defined meaning in regimes with no nonadiabatic coupling.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_adiabatic_populations</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># First get the Hamiltonian and calculate its eigenvalues and eigenvectors.</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">h_quantum</span> <span class="c1"># this is the quantum plus quantum-classical Hamiltonian.</span>
    <span class="c1"># Next obtain its eigenvalues and eigenvectors.</span>
    <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="c1"># Now calculate the adiabatic wavefunction.</span>
    <span class="n">wf_adb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tji,tj-&gt;ti&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">evecs</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">wf_db</span><span class="p">)</span>
    <span class="c1"># Finally calculate the populations (note that we do not sum over the batch, this is done internally by QC Lab).</span>
    <span class="n">pops_adb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wf_adb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1"># Store the populations in the state object.</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pops_adb</span> <span class="o">=</span> <span class="n">pops_adb</span>
    <span class="k">return</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">state</span>
</pre></div>
</div>
<p>Next we can add this task to the output recipe.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MeanField</span><span class="o">.</span><span class="n">output_recipe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_adiabatic_populations</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally we can add the relevant variable name to the output_variables list.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MeanField</span><span class="o">.</span><span class="n">output_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pops_adb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can then run a simulation and plot the populations. Note that since the spin-boson model is always in a coupling regime these populations will not have a well-defined meaning.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qc_lab</span> <span class="kn">import</span> <span class="n">Simulation</span>
<span class="kn">from</span> <span class="nn">qc_lab.dynamics</span> <span class="kn">import</span> <span class="n">serial_driver</span>
<span class="kn">from</span> <span class="nn">qc_lab.models</span> <span class="kn">import</span> <span class="n">SpinBoson</span>

<span class="c1"># Instantiate a simulation.</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default simulation settings: &#39;</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">default_settings</span><span class="p">)</span>

<span class="c1"># Change settings to customize simulation.</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">num_trajs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># Instantiate a model.</span>
<span class="n">sim</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SpinBoson</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default model constants: &#39;</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">default_constants</span><span class="p">)</span> <span class="c1"># print out default constants</span>

<span class="c1"># Instantiate an algorithm.</span>
<span class="n">sim</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">MeanField</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default algorithm settings: &#39;</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">default_settings</span><span class="p">)</span> <span class="c1"># print out default settings</span>



<span class="c1"># Define an initial diabatic wavefunction.</span>
<span class="n">sim</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">wf_db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># Run the simulation.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">serial_driver</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

<span class="c1"># Plot the data.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calculated quantities:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">classical_energy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;classical_energy&#39;</span><span class="p">]</span>
<span class="n">quantum_energy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;quantum_energy&#39;</span><span class="p">]</span>
<span class="n">populations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tii-&gt;ti&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;dm_db&#39;</span><span class="p">]))</span>
<span class="n">adiabatic_populations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;pops_adb&#39;</span><span class="p">])</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tdat_output</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">adiabatic_populations</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;adiabatic state 0&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">adiabatic_populations</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;adiabatic state 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the above code we chose to modify the MeanField class itself rather than an instance of it. This can lead to troublesome
behavior in a Jupyter notebook where the class will not be reloaded if the cell is rerun. Restarting the kernel
will fix this issue. Otherwise one can modify an instance of the class by creating a new instance and modifying it.</p>
</div>
</section>
</section>
<section id="modifying-algorithm-behavior">
<h2>Modifying algorithm behavior<a class="headerlink" href="#modifying-algorithm-behavior" title="Link to this heading">#</a></h2>
<p>In the same way that we could modify the output recipe, it is possible to modify the initialization and update recipes in the same way.
We will not go into detail on how to do this here but the process is the same as for the output recipe (except there is no output variable in those cases).</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="defaults.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Default Behavior</p>
      </div>
    </a>
    <a class="right-next"
       href="../software_reference/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Software Reference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-output-obvservables">Adding output obvservables</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-response-functions">Linear response functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adiabatic-populations">Adiabatic populations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-algorithm-behavior">Modifying algorithm behavior</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user_guide/algorithm_dev.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025-2025, Tempelaar Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>